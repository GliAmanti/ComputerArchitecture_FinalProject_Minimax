TESTS := $(basename $(wildcard test_*.S)) $(basename $(wildcard test_*.c))

CROSS_CC?=riscv64-unknown-elf-gcc
CROSS_OBJCOPY?=riscv64-unknown-elf-objcopy
VIVADO?=/opt/xilinx/Vivado/2022.1

SHELL=/bin/bash
XVHDL=. $(VIVADO)/settings64.sh && xvhdl
XELAB=. $(VIVADO)/settings64.sh && xelab

CFLAGS := -march=rv32ic -mabi=ilp32	\
	  -fno-pic -nostartfiles -nostdlib

LDFLAGS := -march=rv32ic -mabi=ilp32	\
	   -fno-pic -Wl,--no-relax	\
	   -nostartfiles -nostdlib

VDBS := xsim.dir/work/minimax.vdb	\
	xsim.dir/work/minimax_tb.vdb

SIM := xsim.dir/minimax/axsim

default: dirs sim $(addsuffix /pass, $(TESTS))

dirs:
	-@mkdir -p $(TESTS) xsim.dir/minimax

sim: $(SIM)

VPATH=../asm

clean:
	rm -rf *.o *.log *.pb *.jou xsim.dir axsim.sh $(TESTS)

.PHONY: default clean dirs sim $(TESTS)
.PRECIOUS: $(VDBS) %/a.out %/test.mem

# Make each test case try to generate a "pass" file
.SECONDEXPANSION:
$(TESTS): dirs $(SIM) $$@/pass

# ...the "pass" file is generated by a successful simulation result
%/pass: %/test.mem
	-@cd $* && ln -sf ../xsim.dir .
	cd $* && \
		LD_LIBRARY_PATH=$(VIVADO)/lib/lnx64.o:$(VIVADO)/lib/lnx64.o/Default	\
		../$(SIM) > log
	@grep -q SUCCESS $*/log || { echo "$*: failed!" && /bin/false; }
	touch $@

# xelab
$(SIM): $(VDBS)
	# invalidate "pass" results when we regenerate the simulation.
	-find $(TESTS) -name pass -exec rm {} \;
	$(XELAB) -s minimax --generic_top MAXTICKS=100000 --generic_top ROM_FILENAME=test.mem -a work.minimax_tb

# xvhdl
xsim.dir/work/%.vdb: ../rtl/%.vhd
	$(XVHDL) --2008 $<

# assembler, compiler, linker
%.o: %.S
	$(CROSS_CC) $(CFLAGS) -c -o $@ \
		-DTEST_FUNC_NAME=$* -DTEST_FUNC_TXT='"$*"' -DTEST_FUNC_RET=$*_ret $<

%.o: %.c
	$(CROSS_CC) $(CFLAGS) -Os -c -o $@ $<

%/a.out: %.o microcode.o
	$(CROSS_CC) $(LDFLAGS) -T bare.ld -o $@ $^

# .mem generator
%/test.mem: %/a.out bin2mem
	$(CROSS_OBJCOPY) -O binary $< $@.bin
	./bin2mem $@.bin $@
